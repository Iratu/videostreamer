<html>
<head>
    <title>VIDEO</title>
</head>
<body>
<video width="640" height="360">
</video>
<audio></audio>
<p id="status">Waiting</p>
<p id="subscribers">Booting...</p>
Sources: <a href="https://github.com/eientei/videostreamer/tree/nextgen">https://github.com/eientei/videostreamer/tree/nextgen</a>
<script src="/js/lib/utf8/2.1.1/utf8.js"></script>
<script type="application/javascript">
    var CommType = {
        STREAM_PLAY: 1,
        STREAM_STOP: 2,
        STREAM_UPDATE_AV: 3,
        STREAM_SUBSCRIBERS: 4,
        STREAM_UPDATE_A: 5,
        STREAM_UPDATE_V: 6,
        STREAM_UPDATE_VK: 7,
        STREAM_UPDATE_AVK: 8
    };
</script>
<script type="application/javascript">
    function Stream(mediael) {
        var pending = [];
        var buffer = null;

        function drain() {
            if (pending.length == 0 || !buffer || buffer.updating) {
                return;
            }
            buffer.appendBuffer(pending.shift());
        }

        this.begin = function (codecs) {
            var mediaSource = new MediaSource();
            mediael.src = URL.createObjectURL(mediaSource);
            mediael.load();
            mediaSource.addEventListener('sourceopen', function () {
                buffer = mediaSource.addSourceBuffer(codecs);
                buffer.addEventListener('updateend', drain);
            });
        };

        this.stop = function () {
            pending = [];
        };

        this.update = function (data) {
            pending.push(data);
            drain();
        };
    }
</script>
<script type="application/javascript">
    function Comm(hostname, handlers) {
        if (!handlers) {
            handlers = {};
        }

        function readInt(buf, offset) {
            if (!offset) {
                offset = 0;
            }
            return (buf[offset+0] << 24) | (buf[offset+1] << 16) | (buf[offset+2] << 8) | (buf[offset+3]);
        }

        function readString(buf, offset) {
            if (!offset) {
                offset = 0;
            }
            var str = '';
            for (var i = offset; i < buf.length; i++) {
                str += String.fromCharCode(buf[i]);
            }
            return utf8.decode(str);
        }

        var comm = new WebSocket("ws://" + hostname + "/comm");
        comm.binaryType = "arraybuffer";

        comm.onopen = function () {
            comm.send("{\"play\": \"" + "baka" + "\"}");
        };

        comm.onclose = function () {
            console.log('sock closed');
            setTimeout(function () {
                new Comm(hostname, handlers);
            }, 1000);
        };

        comm.onmessage = function (msg) {
            var data = new Uint8Array(msg.data, 4);
            var type = readInt(new Uint8Array(msg.data, 0, 4));
            switch (type) {
                case CommType.STREAM_PLAY:
                    console.log('issuing play');
                    if (handlers.streamPlay) {
                        handlers.streamPlay(readString(data));
                    }
                    break;
                case CommType.STREAM_STOP:
                    console.log('issuing stop');
                    if (handlers.streamStop) {
                        handlers.streamStop();
                    }
                    break;
                case CommType.STREAM_SUBSCRIBERS:
                    if (handlers.streamSubscribers) {
                        handlers.streamSubscribers(readInt(data));
                    }
                    break;
                case CommType.STREAM_UPDATE_AV:
                case CommType.STREAM_UPDATE_A:
                case CommType.STREAM_UPDATE_V:
                case CommType.STREAM_UPDATE_VK:
                case CommType.STREAM_UPDATE_AVK:
                    if (handlers.streamUpdate) {
                        handlers.streamUpdate(data, type);
                    }
                    break;
            }
        };
    }
</script>
<script type="application/javascript">
    //var video = document.querySelector("video");
    //var audio = document.querySelector("audio");
    //var astream = new Stream(audio);
    //var vstream = new Stream(video);
    var avideo = document.querySelector("video");
    var avstream = new Stream(avideo);
    var init = true;
    var minlate = 3;
    var maxlate = 6;
    var lastkey = 0;

    function timesync() {
        console.log('timesync');
        var newcur = null;

        if (avideo.buffered.length > 0) {
            var last = avideo.buffered.end(0);
            var difflate = last - avideo.currentTime;
            if (init) {
                if (difflate > minlate) {
                    init = false;
                    //minlate = avideo.buffered.end(0) - lastkey;
                    //maxlate = minlate * 2;
                    avideo.currentTime = last - minlate;
                    avideo.play();
                    console.log('starting with', minlate, maxlate);
                    document.getElementById("status").innerText = "Playing";
                }
                lastkey = avideo.buffered.end(0);
            } else {
                if (difflate > maxlate) {
                    console.log('adjusting late', difflate);
                    newcur = last - minlate;
                }
            }
        }

        if (newcur) {
            avideo.currentTime = newcur;
        }
/*
        var maxcur = Math.max(audio.currentTime, video.currentTime);
        var mincur = Math.min(audio.currentTime, video.currentTime);
        var diffcur = maxcur - mincur;

        var newaud = null;
        var newcur = null;
        if (diffcur > 0.2) {
            newaud = video.currentTime;
            console.log('adjusting sync', diffcur);
        }
*/
        /*
        var newaud = null;
        var newcur = null;
        if (diffcur > 0.3) {
            console.log('adjusting sync', diffcur);
            mincur + diffcur / 2
        }
        */
/*
        if (audio.buffered.length > 0 && video.buffered.length > 0) {
            var last = Math.min(audio.buffered.end(0), video.buffered.end(0));
            var difflate = last - video.currentTime;
            if (init) {
                if (lastkey > 0 && difflate > minlate) {
                    init = false;
                    minlate = video.buffered.end(0) - lastkey;
                    maxlate = minlate * 2;
                    video.currentTime = audio.currentTime = last - minlate;
                    audio.play();
                    video.play();
                    console.log('starting with', minlate, maxlate);
                    document.getElementById("status").innerText = "Playing";
                }
                lastkey = video.buffered.end(0);
            } else {
                if (difflate > maxlate) {
                    console.log('adjusting late', difflate);
                    newcur = last - minlate;
                }
            }
        }
*/
/*
        if (newcur) {
            video.currentTime = audio.currentTime = newcur;
        } else if (newaud) {
            audio.currentTime = newaud;
        }
        */
    }

    new Comm(window.location.host, {
        streamPlay: function (codecs) {
            document.getElementById("status").innerText = "Buffering";
            //astream.begin('audio/mp4; codecs="mp4a.40.2"');
            //vstream.begin('video/mp4; codecs="avc1.42E01E"');
            avstream.begin('video/mp4; codecs="' + codecs + '"');
        },
        streamStop: function () {
            document.getElementById("status").innerText = "Waiting";
            //astream.stop();
            //vstream.stop();
            avstream.stop();
            init = true;
        },
        streamUpdate: function (data, type) {
            switch (type) {
                case CommType.STREAM_UPDATE_AVK:
                    timesync();
                case CommType.STREAM_UPDATE_AV:
                    avstream.update(data);
                    break;
                /*
                case CommType.STREAM_UPDATE_A:
                    //astream.update(data);
                    break;
                case CommType.STREAM_UPDATE_VK:
                    //timesync();
                case CommType.STREAM_UPDATE_V:
                    //vstream.update(data);
                    break;
                */
            }
        },
        streamSubscribers: function (count) {
            document.getElementById("subscribers").innerText = "Subscribers: " + count;
        }
    });
</script>
</body>
</html>
