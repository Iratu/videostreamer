<html>
<head>
    <title>VIDEO</title>
</head>
<body>
<video preload="auto" width="640" height="360">
</video>
<script type="application/javascript">
    function play(name) {
        var video = document.querySelector("video");
        var pending = [];
        var appending = false;
        var sourceBuffer = null;
        var newclient = true;
        var inited = false;

        connectSock();

        function tryGetSource(codecs) {
            console.log("initializing with codecs " + codecs);
            if (sourceBuffer == null) {
                var mediaSource = new MediaSource();
                video.src = URL.createObjectURL(mediaSource);
                mediaSource.addEventListener("sourceopen", function () {
                    video.pause();

                    sourceBuffer = mediaSource.addSourceBuffer("video/mp4; codecs=\"" + codecs + "\"");
                    sourceBuffer.addEventListener('updateend', function () {
                        appending = false;
                        drain();

                        if (newclient && video.buffered.length > 0) {
                            var diff = video.buffered.end(0) - video.currentTime;
                            console.log(diff);
                            if (diff > 2.01) {
                                newclient = false;
                                console.log('starting');
                                video.play();
                            }
                        }
                    });
                });
            }
        }

        function connectSock() {
            var sock = new WebSocket("ws://" + window.location.host + "/live");
            sock.binaryType = 'arraybuffer';
            sock.onopen = function () {
                console.log(sock);
                sock.send("{\"play\": \"" + name + "\"}");
            };

            sock.onmessage = function (msg) {
                if (!inited) {
                    inited = true;
                    pending = [];
                    tryGetSource(msg.data);
                } else {
                    pending.push(msg.data);
                    drain();
                }
            };

            sock.onclose = function () {
                if (sourceBuffer != null) {
                    sourceBuffer = null;
                }
                newclient = true;
                inited = false;
                setTimeout(connectSock, 1000);
            };
        }

        function drain() {
            if (pending.length == 0) {
                return;
            }

            if (appending) {
                return;
            }

            if (sourceBuffer == null) {
                return;
            }

            console.log('drain');
            appending = true;
            var arr = new Uint8Array(pending.shift());

            if (video.buffered.length > 0) {
                var last = video.buffered.end(0);
                var diff = last - video.currentTime;
                if (diff > 5) {
                    console.log(diff, 'adjust');
                    video.currentTime = last - 5;
                }
            }
            sourceBuffer.appendBuffer(arr);
        }
    }
    play("baka");
</script>
</body>
</html>
