<html>
<head>
    <title>VIDEO</title>
</head>
<body>
<video controls preload="auto" width="640" height="360">
</video>
<script type="application/javascript">
    function readInt(arr, off) {
        return (arr[off+0] << 24 | arr[off+1] << 16 | arr[off+2] << 8 | arr[off+3]);
    }

    function readFCC(arr, off) {
        if (arr.len < off+4) {
            return null;
        }
        return  String.fromCharCode(arr[off+0]) +
                String.fromCharCode(arr[off+1]) +
                String.fromCharCode(arr[off+2]) +
                String.fromCharCode(arr[off+3]);
    }

    function readBox(data, off) {
        var boxlen = readInt(data, off);
        if (boxlen == null || boxlen == 0) {
            return null;
        }
        return {
            len: boxlen,
            name: readFCC(data, off+4),
            data: new Uint8Array(data.slice(off, off+boxlen))
        };
    }

    function reinit() {
        var video = document.querySelector("video");
        var mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);
        mediaSource.addEventListener("sourceopen", function() {
            var ms = this;
            setTimeout(function () {
                video.pause();
                playStream(ms, video);
            }, 100);
        });
    }

    reinit();

    function playStream(mediaSource, video) {
        var sourceBuffer = mediaSource.addSourceBuffer("video/mp4; codecs=\"avc1.42C01F, mp4a.40.2\"");
        var appending = false;
        var newclient = true;

        setupSock();

        function setupSock() {
            var sock = new WebSocket("ws://" + window.location.host + "/live");

            sock.binaryType = 'arraybuffer';
            sock.onopen = function () {
                newclient = true;
                console.log(sock);
                sock.send("{\"action\": \"play\", \"stream\": \"baka\"}");
            };
            sock.onmessage = function (msg) {
                pending.push(msg.data);
                drain();
            };
            sock.onclose = function () {
                mediaSource.removeSourceBuffer(sourceBuffer);
                reinit();
            };
        }

        var pending = [];
        sourceBuffer.addEventListener('updateend', function () {
            appending = false;
            drain();
            if (newclient && video.buffered.length > 0) {
                console.log(video.currentTime, video.buffered.end(0));
                if (video.buffered.end(0) - video.currentTime > 3) {
                    console.log('starting');
                    video.play();
                    newclient = false;
                }
            }
        });

        function drain() {
            if (pending.length == 0) {
                return;
            }
            if (appending) {
                return;
            }
            console.log('drain');
            appending = true;
            var arr = new Uint8Array(pending.shift());

            var off = 0;
            var box = null;
            do {
                box = readBox(arr, off);
                if (box != null) {
                    //console.log(box);
                    off += box.len;
                }
            } while (box != null);
            if (!newclient && video.buffered.length > 0) {
                var last = video.buffered.end(0);
                var diff = last - video.currentTime;
                if (diff > 5) {
                    video.currentTime = last - 5;
                }
            }
            sourceBuffer.appendBuffer(arr);
        }
    }
</script>
</body>
</html>
