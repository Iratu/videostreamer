<html>
<head>
    <title>VIDEO</title>
    <style type="text/css">
        .spinner {
            background: url("/app/img/yukkuri-t.gif") no-repeat center;
            background-size: 50%;
            position: absolute;
            margin: auto;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            display: none;
            width: 218px;
            height: 253px;
        }
        .videocontainer {
            position: relative;
            width: 960px;
            height: 540px;
        }
    </style>
</head>
<body>
<div class="videocontainer">
    <video autoplay width="960" height="540"></video>
    <div class="spinner"></div>
</div>
<p>Subscribers: <span id="subscribers">0</span></p>
<p>
    Sources: <a href="https://github.com/eientei/videostreamer/tree/nextgen">https://github.com/eientei/videostreamer/tree/nextgen</a>
</p>
<script type="application/javascript" src="/app/js/chunked-request.js"></script>
<script type="application/javascript">
    var mimeType = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
    var video = document.querySelector('video');
    var spinner = document.querySelector(".spinner");
    var playing = false;
    video.ontimeupdate = function () {
        if (video.buffered.length < 1) {
            return;
        }
        console.log('timeupd', video.buffered.end(0));
        //video.duration = -1;
        if (video.currentTime > 0 && video.buffered.end(0) - video.currentTime > 3) {
            console.log('adjusting');
            video.currentTime = video.buffered.end(0) - 3;
        }
    };
    video.oncanplaythrough = function () {
        video.play();
    };
    video.onloadstart = function () {
        spinner.style.display = 'block';
    };
    video.onpause = function () {
        spinner.style.display = 'block';
    };
    video.onplaying = function () {
        spinner.style.display = 'none';
    };
    video.onstalled = function () {
        spinner.style.display = 'block';
    };

    go();

    function go() {
        var comm = new WebSocket("ws://" + window.location.host + "/comm");
        comm.onmessage = function (ev) {
            var data = JSON.parse(ev.data);
            if (data.action == 'play') {
                play(data.stream);
                playing = true;
            } else if (data.action == 'stop') {
                stop(data.stream);
                playing = false;
            } else if (data.action == 'subscribers') {
                document.getElementById('subscribers').innerText = data.count;
            }
        };
        comm.onclose = function () {
            setTimeout(go, 2000);
        };
    }

    function play(stream) {
        console.log('play', stream);
        var url = '/live/' + stream + '.mp4';
        if ('MediaSource' in window && 'fetch' in window) {
            var mediaSource = new MediaSource;
            video.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', function () {
                var mediaSource = this;
                var sourceBuffer = mediaSource.addSourceBuffer(mimeType);
                var chunks = [];
                sourceBuffer.addEventListener('updateend', function () {
                    trypush();
                });
                function trypush() {
                    if (chunks.length == 0 || !sourceBuffer || sourceBuffer.updating) {
                        return;
                    }
                    var chunk = chunks.shift();
                    sourceBuffer.appendBuffer(chunk);
                }
                reconnect();
                function reconnect() {
                    chunkedRequest({
                        url: url,
                        method: 'GET',
                        chunkParser: function (raw) {
                            return [ raw, {} ];
                        },
                        onChunk: function (err, msg) {
                            chunks.push(msg);
                            trypush();
                        }
                    });
                }
            });
        } else {
            console.log('old');
            video.src = url;
            video.type = mimeType;
            video.load();
            video.play();
        }
    }

    function stop(stream) {
        console.log('stop', stream);
    }
</script>
</body>
</html>
