<html>
<head>
    <title>VIDEO</title>
    <style type="text/css">
        .spinner {
            background: url("/app/img/yukkuri-t.gif") no-repeat center;
            background-size: 50%;
            position: absolute;
            margin: auto;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            display: none;
            width: 218px;
            height: 253px;
        }
        .videocontainer {
            position: relative;
            width: 960px;
            height: 540px;
        }
    </style>
</head>
<body>
<div class="videocontainer">
    <video width="960" height="540"></video>
    <div class="spinner"></div>
</div>
<audio></audio>
<p id="status">Waiting</p>
<p id="subscribers">Booting...</p>
Sources: <a href="https://github.com/eientei/videostreamer/tree/nextgen">https://github.com/eientei/videostreamer/tree/nextgen</a>
<script src="/js/lib/utf8/2.1.1/utf8.js"></script>
<script type="application/javascript">
    var CommType = {
        STREAM_PLAY: 1,
        STREAM_STOP: 2,
        STREAM_UPDATE_AV: 3,
        STREAM_SUBSCRIBERS: 4,
        STREAM_UPDATE_A: 5,
        STREAM_UPDATE_V: 6,
        STREAM_UPDATE_VK: 7,
        STREAM_UPDATE_AVK: 8,
        STREAM_UPDATE_AK: 9
    };
</script>
<script type="application/javascript">
    function Stream(mediael) {
        var pending = [];
        var buffer = null;
        var seq = 0;
        var post = [];
        this.ondone = null;
        this.stalled = false;

        var my = this;
        var current = mediael.currentTime;
        setInterval(function () {
            if (!mediael.paused) {
                if (!my.stalled && mediael.currentTime < current+0.02) {
                    console.log('stall');
                    my.stalled = true;
                } else if (my.stalled && mediael.currentTime > current+0.02) {
                    console.log('unstall');
                    my.stalled = false;
                }
            }
            current = mediael.currentTime;
        }, 100);


        function drain() {
            if (pending.length == 0 || !buffer || buffer.updating) {
                return;
            }
            var next = pending.shift();
            post.push(next.meta);
            buffer.appendBuffer(next.data);
        }

        this.begin = function (codecs) {
            var mediaSource = new MediaSource();
            mediael.src = URL.createObjectURL(mediaSource);
            mediael.load();
            mediaSource.addEventListener('sourceopen', function () {
                buffer = mediaSource.addSourceBuffer(codecs);
                buffer.addEventListener('updateend', function () {
                    drain();
                    var meta = post.shift();
                    if (my.ondone) {
                        my.ondone(meta);
                    }
                });
            });
        };

        this.stop = function () {
            pending = [];
            seq = 0;
        };

        this.update = function (type, data, begin, end) {
            pending.push({
                data: data,
                meta: {
                    type: type,
                    begin: begin,
                    end: end,
                    seq: seq++
                }
            });
            drain();
        };
    }
</script>
<script type="application/javascript">
    function Comm(hostname, handlers) {
        if (!handlers) {
            handlers = {};
        }

        function readInt(buf, offset) {
            if (!offset) {
                offset = 0;
            }
            return (buf[offset+0] << 24) | (buf[offset+1] << 16) | (buf[offset+2] << 8) | (buf[offset+3]);
        }

        function readString(buf, offset) {
            if (!offset) {
                offset = 0;
            }
            var str = '';
            for (var i = offset; i < buf.length; i++) {
                str += String.fromCharCode(buf[i]);
            }
            return utf8.decode(str);
        }

        var comm = new WebSocket("ws://" + hostname + "/comm");
        comm.binaryType = "arraybuffer";

        comm.onopen = function () {
            comm.send("{\"play\": \"" + "baka" + "\"}");
        };

        comm.onclose = function () {
            console.log('sock closed');
            setTimeout(function () {
                new Comm(hostname, handlers);
            }, 1000);
        };

        comm.onmessage = function (msg) {
            var data = new Uint8Array(msg.data, 12);
            var type = readInt(new Uint8Array(msg.data, 0, 4));
            var begin = readInt(new Uint8Array(msg.data, 4, 4));
            var end = readInt(new Uint8Array(msg.data, 8, 4));
            switch (type) {
                case CommType.STREAM_PLAY:
                    console.log('issuing play');
                    if (handlers.streamPlay) {
                        handlers.streamPlay(readString(data));
                    }
                    break;
                case CommType.STREAM_STOP:
                    console.log('issuing stop');
                    if (handlers.streamStop) {
                        handlers.streamStop();
                    }
                    break;
                case CommType.STREAM_SUBSCRIBERS:
                    if (handlers.streamSubscribers) {
                        handlers.streamSubscribers(readInt(data));
                    }
                    break;
                case CommType.STREAM_UPDATE_AV:
                case CommType.STREAM_UPDATE_A:
                case CommType.STREAM_UPDATE_V:
                case CommType.STREAM_UPDATE_VK:
                case CommType.STREAM_UPDATE_AVK:
                case CommType.STREAM_UPDATE_AK:
                    if (handlers.streamUpdate) {
                        handlers.streamUpdate(data, type, begin, end);
                    }
                    break;
            }
        };
    }
</script>
<script type="application/javascript">
    var video = document.querySelector("video");
    var audio = document.querySelector("audio");
    var spinner = document.querySelector(".spinner");
    var astream = new Stream(audio);
    var vstream = new Stream(video);
    var init = true;
    var minlate = 2;
    var maxlate = 5;
    var thres = 0.2;
    var lastmeta = null;
    var probing = false;
    var prevtime;
    var start = 0;
    var auds = 0;

    vstream.ondone = function (meta) {
        switch (meta.type) {
            case CommType.STREAM_UPDATE_VK:
            case CommType.STREAM_UPDATE_AVK:
                if (init && meta.begin > 0) {
                    var begin = meta.begin / 1000 - minlate;
                    init = false;
                    video.currentTime = begin;
                    //audio.currentTime = begin;
                    video.play();
                    //audio.play();
                    spinner.style.display = 'none';
                    /*
                    var inter = setInterval(function () {
                        if (video.currentTime > begin) {
                            setTimeout(function () {
                                if (!vstream.stalled) {
                                    clearInterval(inter);
                                    spinner.style.display = 'none';
                                    audio.currentTime = video.currentTime;
                                }
                            }, maxlate * 1000);

                        }
                    }, 50);
                    */
                } else if (meta.begin > 0) {
                    var dest = meta.begin/1000 - minlate;
                    if (Math.abs(video.currentTime - dest) > 1.0) {
                        console.log('v', dest, video.currentTime - dest);
                        video.currentTime = dest;

                        console.log('a', dest, audio.currentTime - dest);
                        audio.currentTime = dest;
                    }
                    /*
                    var diff = audio.currentTime - video.currentTime;
                    console.log('a/v', diff);
                    audio.currentTime -= diff/2;
                    video.currentTime += dest/2;
                    */
                    /*
                    var dest = meta.begin/1000 - minlate;
                    console.log(dest, video.currentTime);
                    if (dest < video.currentTime) {
                        video.pause();
                        setTimeout(function () {
                            video.play();
                            //audio.currentTime -= audio.currentTime - video.currentTime;
                        }, (video.currentTime - dest)*1000);
                    } else {
                        video.currentTime = dest;
                        //audio.currentTime -= diff/2;
                    }
                    */
                    //console.log(dest);
                    //var diff = audio.currentTime - video.currentTime;
                    //audio.currentTime -= diff;
                    //video.currentTime += dest/2;
                }
                break;
            case CommType.STREAM_UPDATE_V:
            case CommType.STREAM_UPDATE_AV:
                break;
        }
    };

    astream.ondone = function (meta) {
        auds++;
        if (auds % 8 == 0) {
//            var dest = meta.begin/1000 - minlate;
//            console.log('a', dest, audio.currentTime - dest);
//            audio.currentTime = dest;
            /*
            console.log('aud', dest, audio.currentTime);
            if (dest < audio.currentTime) {
                audio.pause();
                setTimeout(function () {
                    audio.play();
                    //audio.currentTime -= audio.currentTime - video.currentTime;
                }, (audio.currentTime - dest)*1000);
            } else {
                audio.currentTime = dest;
            }
            */
        }
    };

    /*
    var adat;
    var vdat;

    function extsync() {
        var mintime = Math.min(audio.currentTime, video.currentTime);
        var mindiff = Math.min(adat.begin, vdat.begin)/1000;

        var na = null;
        var nv = null;


        if (mindiff - mintime > maxlate) {
            var jump = mindiff - minlate;
            console.log('a/v jump', jump);
            na = jump;
            nv = jump;
        }

        if (na) {
            audio.currentTime = na;
        }

        if (nv) {
            video.currentTime = nv;
        }
    }

    function avsync() {
        if (init) {
            return;
        }

        var na = null;
        var nv = null;

        var apos = (na == null ? adat.begin/1000 : na) - minlate;
        var vpos = (nv == null ? vdat.begin/1000 : nv) - minlate;
        var avdiff = apos - vpos;

        console.log(avdiff);
        if (Math.abs(avdiff) > thres) {
            console.log('a/v sync', avdiff);
            na = audio.currentTime - avdiff / 2;
            nv = video.currentTime + avdiff / 2;
        }

        if (na) {
            audio.currentTime = na;
        }

        if (nv) {
            video.currentTime = nv;
        }
    }

    vstream.ondone = function (meta) {
        lastmeta = meta;
        switch (meta.type) {
            case CommType.STREAM_UPDATE_VK:
                vdat = meta;
                if (init) {
                    if (meta.begin/1000 > minlate) {
                        video.currentTime = meta.begin - minlate;
                        audio.currentTime = meta.begin - minlate;
                        video.play();
                        audio.play();
                        init = false;
                        spinner.style.display = 'none';
                    }
                } else {
                    extsync();
                    avsync();
                }
                break;
            case CommType.STREAM_UPDATE_V:
                vdat = meta;
                break;
        }
    };
    astream.ondone = function (meta) {
        switch (meta.type) {
            case CommType.STREAM_UPDATE_AK:
            case CommType.STREAM_UPDATE_A:
                adat = meta;
                break;
        }
    };
    */

    new Comm(window.location.host, {
        streamPlay: function (codecs) {
            spinner.style.display = 'block';
            document.getElementById("status").innerText = "Buffering";
            //astream.begin('audio/mp4; codecs="mp4a.40.2"');
            //vstream.begin('video/mp4; codecs="avc1.42E01E"');
            vstream.begin('video/mp4; codecs="' + codecs + '"');
        },
        streamStop: function () {
            spinner.style.display = 'none';
            document.getElementById("status").innerText = "Waiting";
            astream.stop();
            vstream.stop();
            init = true;
        },
        streamUpdate: function (data, type, begin, end) {
            console.log('type ' + type + ' ' + begin + '..' + end);
            switch (type) {
                case CommType.STREAM_UPDATE_AK:
                case CommType.STREAM_UPDATE_A:
                    astream.update(type, data, begin, end);
                    break;
                case CommType.STREAM_UPDATE_VK:
                case CommType.STREAM_UPDATE_V:
                case CommType.STREAM_UPDATE_AV:
                case CommType.STREAM_UPDATE_AVK:
                    vstream.update(type, data, begin, end);
                    break;
            }
        },
        streamSubscribers: function (count) {
            document.getElementById("subscribers").innerText = "Subscribers: " + count;
        }
    });
</script>
</body>
</html>
